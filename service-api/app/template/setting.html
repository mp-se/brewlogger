{% extends "base.html" %}
{% set active_page = "settings" %}

{% block content %}

<div class="container-fluid p-3">

  {% include 'brewloggerapi.j2' %}

  <h1 class="h1">Settings</h1>

  <hr>

  <div class="row mb-2">
    <div class="col-sm-2">Javsscript debug</div>
    <div class="col-sm-5">
      {% if settings.javascript_debug_enabled %}
      <button type="button" class="btn btn-primary" onclick="disableJavascriptDebug()">Disable debug</button>
      {% else %}
      <button type="button" class="btn btn-primary" onclick="enableJavascriptDebug()">Enable debug</button>
      {% endif %}
    </div>

    <script>
    async function enableJavascriptDebug() {
      data = { 
        "javascript_debug_enabled": true
      };
      
      await api.updateSetting(data, function() { 
        console.log("Enabled debug"); 
        location.reload();
     });
    } 

    async function disableJavascriptDebug() {
      data = { 
        "javascript_debug_enabled": false
      };
      
      await api.updateSetting(data, function() { 
        console.log("Disabled debug"); 
        location.reload();
     });
    } 
    </script>
  </div>

  <hr>

  <div class="row mb-2">
    <div class="col-sm-2">Backup</div>
    <div class="col-sm-5">
      <button type="button" class="btn btn-primary" onclick="backup()">Backup data</button>
    </div>
  </div>

  <hr>

  <form id="uploadForm" enctype="multipart/form-data">
    <div class="row mb-2">
      <div class="col-sm-2">Restore</div>
        <div class="col-sm-5 custom-file">
          <input type="file" accept=".txt" id="name" class="custom-file-input">
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-sm-2"></div>
        <div class="col-sm-9">
          <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      </div>

      <div class="row mb-2">
        <div class="col-sm-2"></div>
        <div class="col-sm-5">
          <button type="button" class="btn btn-primary" onclick="restore()">Restore data</button>
        </div>
      </div>
  </form>

  <script> 
    var progress = 0;
    var progress_max = 1;

    function updateProgress() {
      progress = progress + (100/progress_max); // In total 1 steps to do restore
      $('.progress-bar').css('width', progress+'%').attr('aria-valuenow', progress).text(parseFloat(progress).toFixed(0) + "%");
    }

    async function restore() {
      console.log("Restoring data");
      const fileElement = document.getElementById('name');

      if( {{ records }} > 0){
        showError("Database is not empty, unable to restore.");
        return;
      }

      if(fileElement.files.length === 0) {
        showError("You need to select one file to restore configuration from.");
        return;
      } 

      console.log( "Selected file: " + fileElement.files[0].name );

      let text = await new Promise((resolve) => {
        let fileReader = new FileReader();
        fileReader.readAsText(fileElement.files[0]);
        fileReader.onload = (e) => resolve(fileReader.result);
      });

      // Process the backup file
      json = JSON.parse( text );
      console.log(json);

      dev_cnt = json["devices"].length;
      batch_cnt = json["batches"].length * 2;

      progress = 0;
      progress_max = dev_cnt + batch_cnt;

      console.log("Number of requests needed:", progress_max);

      for(device of json["devices"]) {
        await api.addDevice(device, function(res, status, success) { 
          device.id = res.id;
          updateProgress();
          console.log("Added device.", device.id); 
        });
      };

      for(batch of json["batches"]) {
        await api.addBatch(batch, function(res, status, success) { 
          batch.id = res.id;

          batch.gravity.forEach(g => {
            g.batchId = res.id;            
          });

          api.addGravityList(batch.gravity, function(res, status, success) { 
            updateProgress();
            console.log("Added gravity list."); 
          });

          updateProgress();
          console.log("Added batch.", batch.id); 
        });
      }
    }

    async function backup() {
      console.log("Creating backup of data");

      backup = {};
      var meta = {};
      var batches = [];
      var devices = [];
      var gravities = [];
      meta["version"] = "0.2";
      meta["software"] = "BrewLogger";
      backup["meta"] = meta;

      b = api.getBatchList(function(json, status, success) { 
        batches = json; 
        if(!success)
          showError("Failed to fetch batches");
        else
          console.log("Fetched batches."); 
      });
  
      d = api.getDeviceList(function(json, status, success) { 
        devices = json; 
        if(!success)
          showError("Failed to fetch devices");
        else
          console.log("Fetched devices."); 
      });

      Promise.all([b,d]).then( function() {
        console.log("Creating backup file");

        backup["batches"] = batches;
        backup["devices"] = devices;

        var s = JSON.stringify(backup, null, 2);
        console.log(s);
        download(s, "text/plain", "brewlogger_backup.txt");
      });

    }

    function download(content, mimeType, filename) {
      const a = document.createElement('a') 
      const blob = new Blob([content], {type: mimeType}) 
      const url = URL.createObjectURL(blob) 
      a.setAttribute('href', url) 
      a.setAttribute('download', filename) 
      a.click()
    }
  </script>

  <hr>

  {% if settings.test_endpoints_enabled == True %}

  <div class="row mb-2">
    <div class="col-sm-2">Unit Tests</div>
    <div class="col-sm-5">
      <button type="button" class="btn btn-info" onclick="event.preventDefault(); window.location.href='/html/test/unit/'">Run javascript unit tests</button>
    </div>
  </div>

  <hr>

  <div class="row mb-2">
    <div class="col-sm-2">Generate data</div>
    <div class="col-sm-9">
      <button type="button" class="btn btn-info" onclick="deleteDatabase()">Delete all records</button>
      <button type="button" class="btn btn-info" onclick="generateDeviceData()">Generate devices</button>
      <button type="button" class="btn btn-info" onclick="generateBatches()">Generate batches</button>
      <button type="button" class="btn btn-info" onclick="generateGravityData(50)">Generate gravity</button>
      <button type="button" class="btn btn-info" onclick="ispindelSimulation()">Simulate iSpindel</button>
      <button type="button" class="btn btn-info" onclick="location.reload()">Reload</button>
    </div>

  </div>

  <hr>

  {% include 'tests.j2' %}

  {% endif%}

</div>

{% endblock %}
